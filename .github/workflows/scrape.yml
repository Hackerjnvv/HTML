name: Daily Birthday Scraper and Formatter

on:
  schedule:
    # Ye script har roz subah 11:00 AM (IST) par chalega.
    # 05:30 UTC = 11:00 AM IST
    - cron: '30 5 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  scrape-and-format:
    runs-on: ubuntu-latest
    steps:
      # Step 1: Repository ka code download karna
      - name: Check out repository
        uses: actions/checkout@v3

      # Step 2: Python environment set up karna
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      # Step 3: Dono scripts ke liye saari zaroori libraries install karna
      - name: Install all dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 openpyxl lxml

      # Step 4: Pehla script (scraper) run karna
      - name: Run the scraper script (scraper.py)
        run: python scraper.py

      # Step 5: Doosra script (formatter) run karna
      - name: Run the formatter script (formattor.py)
        run: python formattor.py

      # Step 6: Check karna ki koi nayi file bani hai ya nahi, aur agar bani hai to use commit karna
      - name: Commit and push if changes were made
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'actions-bot@github.com'
          git add BD/ last_hash.txt "Birthday Data Master.xlsx"
          # Date ko IST mein commit karne ke liye TZ='Asia/Kolkata' istemal karenge
          # Is time par date same hi hogi, but ye tarika best practice hai.
          git diff --staged --quiet || (git commit -m "Automated data scrape and format for $(TZ='Asia/Kolkata' date +'%Y-%m-%d')" && git push)
